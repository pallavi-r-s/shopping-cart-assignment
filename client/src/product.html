<!DOCTYPE html>
<html lang="en">
<head
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height ,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>SABKA BAZAR</title>
    
    <link rel="stylesheet" type="text/css" href="./styles/product.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

</head>
<body>
  <header>
        <nav id="main-navbar" class="navbar navbar-default navbar-fixed-top">
            <div class="container navbar-container">
                <div class="navbar-header">
                    <!-- <p class="logo"><img src="./static/images/logo.png"></p> -->
                    <a class="navbar-brand" href="#"><img src="./static/images/logo.png"></a>
                    <div id="navbar" style="margin-top: -98px;margin-left: 200px;display: flex;" class="navbar-collapse collapse">
                        <ul style="list-style:none;" class="nav navbar-nav navbar-left">
                            <li><a href="./home.html">Home</a></li>
                            <li><a href="./product.html">Products</a></li>
                        </ul>
                        <div style="align-self: center;margin: 20px;">
                            
                            
                            <button class="cart open-button"><img src="./static/images/cart.svg" height="30px" width="26px" alt="cart image"><span>0</span>items</button>
                        </div> 
                        
                    </div>
                    
                </div>
    
                <div class="top-social">
                    <ul id="top-social-menu">
                        
                        <li><a href="./login.html">SignIn</a></li>
                        <li><a href="./register.html">Register</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>
    
    <!-- <div class="spacer">
        &nbsp;
    </div> -->

      <div class="w3-sidebar w3-collapse" id="sidenav">
        <div id="leftmenuinnerproduct">
          <div id="leftmenuinnerinnerproduct">
                <a target="_top" href="#"> Fruits & Vegetables</a>
                
                <a target="_top" href="#"> Bakery Cakes and Diary </a>
                <a target="_top" href="#" class="active">Beverages</a>
                <a target="_top" href="#"> Beauty and Hygiene</a>
                <a target="_top" href="#"> Baby Care</a>
      
            <br><br>
          </div>
        </div>
    </div>

    <dialog class="modal">
        <div class="modal-header">
          <div class="Header">
              <h3 class="Heading">Shopping Cart</h3>
              <h5 class="Action">Remove all</h5>
              <i class="material-icons md-18 close-button">close</i>
              <!-- <ion-icon name="close-outline"></ion-icon> -->
          </div>
          
          <div id="CartContainer">
          </div>
          <div id="checkout">
            
            <button class="button">Checkout</button>
        </div>
        </div>
      </dialog>  

    <main id="main" style="display:inline-flex;margin-left: 440px; padding-top: 0px;"></main>

    <Footer id="footer">
        <div><p> Copyright 2011-2018 Subka Bazaar Grocery Supplies Pvt Ltd </p> </div>
    </Footer>

<script>
        var products = [];
        window.onscroll = function() {fixedHeader()};

        var header = document.getElementById("main-navbar");
        var sticky = header.offsetTop;

        function fixedHeader() {
        if (window.pageYOffset > sticky) {
            header.classList.add("sticky");
        } else {
            header.classList.remove("sticky");
        }
        }

        const modal= document.querySelector('.modal');
        const openModal= document.querySelector('.open-button');
        const closeModal= document.querySelector('.close-button');

        openModal.addEventListener('click', () => {
        modal.showModal();
        });

        closeModal.addEventListener('click', () => {
        modal.close();
        });

        fetch('http://localhost:5000/products')
            .then(function (response) {

                return response.json();
            })
            .then(function (data) {
                appendData(data);
            })
            .catch(function (err) {
                console.log('error: ' + err);
            });
        async function appendData(data){

            console.log(data);

            var mainContainer = document.getElementById("main");

            data.forEach((result, idx) => {

            // Construct card content
            const content = `
                <div class="product-card" class="product-card">

                    <h2 >${result.name}</h2>
                    <div class="product-tumb">
                        <img src=".${result.imageURL}" alt="">
                    </div>
                    <div class="product-details">
                        <p>${result.description}</p>
                            <div class="product-price">MRP Rs.${result.price}
                                <div class="product-links">
                                <button id="buybtn" name="buybtn">Buy Now</button>
                                <button class="addcart" name="buybtn">Add To Cart</button>
                                </div>
                            </div>

                        </div>
                    </div>
            </div>
            `;

            // Append newyly created card element to the container
            mainContainer.innerHTML += content;
            });

            products = await cartItems(data);

            cart(products);

            

        }
        function cartItems(data){

            Object.keys(data).map(
            function(object){
                data[object]["inCart"] = 0;
            });
            return data;
            //console.log("data after adding new key  :",data);
        }
        function onLoadCartNumber(){
            let productNumbers = localStorage.getItem('cartNumber');
            productNumbers = parseInt(productNumbers);
            if(productNumbers){
                document.querySelector('.cart span').textContent=productNumbers;
            }
        }
        function cart(products){
            let carts = document.querySelectorAll('.addcart');
            console.log(carts);
            for(let i=0;i<carts.length;i++){
                carts[i].addEventListener('click',()=>{
                    //console.log("aded to cart")
                    cartNumbers(products[i]);
                    totalCost(products[i]);
                })
            }
        }
        function cartNumbers(product){
                //console.log("product clicked ",product);

                let productNumbers = localStorage.getItem('cartNumber');

                productNumbers = parseInt(productNumbers);
                if(productNumbers){
                    localStorage.setItem('cartNumber',productNumbers + 1);
                    document.querySelector('.cart span').textContent=productNumbers + 1;
                }else{
                    localStorage.setItem('cartNumber',1);
                    document.querySelector('.cart span').textContent=1;
                }

                setItems(product);
            
        }

        function setItems(product){
            //console.log("product in setItems fun " ,product);
            let cartItems = localStorage.getItem('productsInCart');
            cartItems = JSON.parse(cartItems);

            //console.log("product in cart" ,cartItems);

            if(cartItems != null){

                if(cartItems[product.name] == undefined){
                    cartItems = {
                        ...cartItems,
                        [product.name] :product
                    }
                }
                cartItems[product.name].inCart += 1;
            } else{
                product.inCart = 1;
                cartItems = {
                    [product.name]: product
                    }
            }

            localStorage.setItem('productsInCart',JSON.stringify(cartItems));
        }
        function totalCost(product){
            //console.log("totalcost:",product.price);
            let cartCost = localStorage.getItem('cartCost');
            //console.log("cartCost:",cartCost);
            //console.log(typeof cartCost);

            if(cartCost != null){
                cartCost = parseInt(cartCost);
                localStorage.setItem('cartCost',cartCost 
                + product.price)

            }else {
                localStorage.setItem('cartCost',product.price)
            }

            var checkout = document.getElementById("checkout");

            const content =`
            `;

            checkout.innerHTML += content;

        }
        function displayCart(){

            let cartItems = localStorage.getItem("productsInCart");
            cartItems = JSON.parse(cartItems);

            var cartContainer = document.getElementById("CartContainer");

            let cartCost = localStorage.getItem('cartCost');

            console.log("cart items: ",cartItems);
            //console.log("cartContainer",cartContainer);

            if(cartItems){
                //cartContainer.innerHTML = '';
                //console.log("in dispaly if ");
                Object.values(cartItems).map(item =>{

                    //console.log("in dispaly fun ",item.name);

                    const content =`
                    <div class="Cart-Items">
                        <div class="image-box">
                            <img src=".${item.imageURL}" style="height:80px"/>
                        </div>
                        <div class="about">
                            <h6 class="title">${item.name}</h6><br>
                        </div>
                        <div class="counter">
                            <div class="btn">+</div>
                            <div class="count">${item.inCart}</div>
                            <div class="btn">-</div>
                        </div>
                        <div class="prices">
                            <div class="amount">${item.price}</div>
                            <div class="save"><u>Save for later</u></div>
                            <div class="remove"><u>Remove</u></div>
                            
                        </div>
                        <div id="Subtotal">${item.inCart * item.price} 
                        </div>

                    </div>
                    `;

                    cartContainer.innerHTML += content;

                });

                
                cartContainer.innerHTML += `
                
                    <div class="total">
                        <div id="total-amount">Total Cost: ${cartCost}</div>
                    </div>`;
            }

        }
        
        onLoadCartNumber();
        displayCart();
        
    </script>
    <!-- <script defer src="./product.js"></script> -->
</body>
</html>